name: Deploy to web
on:
    # Enable manual run
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy web build"
                required: true
                default: "staging"
                type: choice
                options:
                    - staging
                    - prod

# Declare default permissions as read only.
permissions: read-all

jobs:
    build-and-deploy:
        runs-on: ubuntu-18.04
        steps:
            # Set up Flutter.
            - name: Clone Flutter repository with stable channel
              uses: subosito/flutter-action@dbf1fa04f4d2e52c33185153d06cdb5443aa189d
              with:
                  channel: "stable"
            - run: flutter doctor -v

            - name: Install web dependencies
              uses: actions/setup-node@969bd2663942d722d85b6a8626225850c2f7be4b
              with:
                  node-version: "14"
            - run: npm install -g firebase-tools@11.0.1

            # Checkout code and get packages.
            - name: Checkout code
              uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
            - run: flutter pub get

            # Build and deploy (by default, to staging).
            - run: flutter build -v web --release
            - run: firebase deploy --only hosting:${{ github.event.inputs.environment || 'staging' }}
              env:
                  FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
